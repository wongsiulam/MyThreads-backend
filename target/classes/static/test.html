<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帖子测试</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/nav.css" rel="stylesheet">
    <style>
        .container { margin-top: 30px; }
        .card { margin-bottom: 20px; }
        .btn-group { margin-bottom: 10px; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <div class="nav-container">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="/social.html">社交关系</a>
            </li>
            <li class="nav-item active">
                <a href="/test.html">帖子测试</a>
            </li>
            <li class="nav-item">
                <a href="/chat.html">聊天测试</a>
            </li>
        </ul>
    </div>

    <div class="container">
        <h2>帖子测试</h2>
        
        <!-- 发帖区域 -->
        <div class="card">
            <div class="card-header">
                <h4>发布新帖子</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">用户ID</label>
                    <input type="number" class="form-control" id="userId" value="1" placeholder="请输入用户ID">
                </div>
                <div class="mb-3">
                    <label class="form-label">帖子内容</label>
                    <textarea class="form-control" id="content" rows="3" placeholder="请输入帖子内容"></textarea>
                </div>
                <button class="btn btn-primary" onclick="createPost()">发布帖子</button>
            </div>
        </div>

        <!-- 帖子列表 -->
        <div class="card">
            <div class="card-header">
                <h4>帖子列表</h4>
            </div>
            <div class="card-body">
                <button class="btn btn-info mb-3" onclick="getPosts()">刷新帖子列表</button>
                <div id="postsList"></div>
            </div>
        </div>
    </div>

    <script>
        // 检查登录状态：如果未登录则跳转到登录页面
        function checkLogin() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }

        // 退出登录：清除token并跳转到登录页面
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        // AJAX全局设置：为所有请求添加Authorization头，并统一处理错误
        $.ajaxSetup({
            beforeSend: function(xhr) {
                const token = localStorage.getItem('token');
                if (token) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = '请求失败，请检查网络或服务器日志。';
                if (xhr.responseJSON && xhr.responseJSON.msg) {
                    errorMessage = xhr.responseJSON.msg;
                } else if (xhr.responseText) {
                    errorMessage = xhr.responseText.substring(0, 100);
                }
                alert('错误: ' + errorMessage);

                if (xhr.status === 401) {
                    alert('登录状态已失效，请重新登录。');
                    logout();
                }
            }
        });

        // 设置当前页面的导航项为激活状态
        document.addEventListener('DOMContentLoaded', function() {
            const currentPage = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const link = item.querySelector('a');
                if (link.getAttribute('href') === currentPage) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // 页面加载时检查登录状态并获取帖子列表
            if (checkLogin()) {
                getPosts();
            }
        });

        const userId = document.getElementById('userId');
        const content = document.getElementById('content');

        // 创建帖子
        async function createPost() {
            if (!checkLogin()) return; // 检查登录状态
            try {
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId.value,
                        content: content.value
                    })
                });
                const data = await response.json();
                if (data.code === 200) {
                    alert('帖子发布成功');
                    content.value = '';
                    getPosts();
                } else {
                    alert('发布帖子失败：' + data.msg);
                }
            } catch (error) {
                alert('发布帖子失败：' + error.message);
            }
        }

        // 获取帖子列表
        async function getPosts() {
            if (!checkLogin()) return; // 检查登录状态
            try {
                const response = await fetch('/api/posts');
                const data = await response.json();
                const container = document.getElementById('postsList');
                if (data.code !== 200 || !Array.isArray(data.data)) {
                    container.innerHTML = '<div class="alert alert-info">暂无帖子</div>';
                    return;
                }
                container.innerHTML = data.data.map(post => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h5 class="card-title">用户ID: ${post.userId}</h5>
                            <p class="card-text">${post.content}</p>
                            <div class="btn-group">
                                <button class="btn btn-primary btn-sm" onclick="likePost(${post.id})">点赞</button>
                                <button class="btn btn-info btn-sm" onclick="showComments(${post.id})">评论</button>
                            </div>
                            <div id="comments-${post.id}" class="mt-2"></div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                alert('获取帖子列表失败：' + error.message);
            }
        }

        // 点赞帖子
        async function likePost(postId) {
            if (!checkLogin()) return; // 检查登录状态
            try {
                const response = await fetch(`/api/posts/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId.value
                    })
                });
                const data = await response.json();
                if (data.code === 200) {
                    alert('点赞成功');
                    getPosts();
                } else {
                    alert('点赞失败：' + data.msg);
                }
            } catch (error) {
                alert('点赞失败：' + error.message);
            }
        }

        // 显示评论
        async function showComments(postId) {
            if (!checkLogin()) return; // 检查登录状态
            try {
                const response = await fetch(`/api/posts/${postId}/comments`);
                const data = await response.json();
                const container = document.getElementById(`comments-${postId}`);

                let commentsHtml = '';
                if (data.code === 200 && Array.isArray(data.data)) {
                    commentsHtml = data.data.map(comment => `
                        <div class="card mb-1">
                            <div class="card-body">
                                <p class="card-text">用户ID: ${comment.userId}</p>
                                <p class="card-text">${comment.content}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    commentsHtml = '<div class="alert alert-info">暂无评论</div>';
                }

                container.innerHTML = `
                    <div class="mt-2">
                        <div class="input-group">
                            <input type="text" class="form-control" id="comment-${postId}" placeholder="输入评论">
                            <button class="btn btn-primary" onclick="addComment(${postId})">发送</button>
                        </div>
                        <div class="mt-2">
                            ${commentsHtml}
                        </div>
                    </div>
                `;
            } catch (error) {
                alert('获取评论失败：' + error.message);
            }
        }

        // 添加评论
        async function addComment(postId) {
            if (!checkLogin()) return; // 检查登录状态
            const commentInput = document.getElementById(`comment-${postId}`);
            try {
                const response = await fetch(`/api/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId.value,
                        content: commentInput.value
                    })
                });
                const data = await response.json();
                if (data.code === 200) {
                    commentInput.value = '';
                    showComments(postId);
                } else {
                    alert('添加评论失败：' + data.msg);
                }
            } catch (error) {
                alert('添加评论失败：' + error.message);
            }
        }

        // 页面加载时获取帖子列表 (已移至DOMContentLoaded中)
        // getPosts();
    </script>
</body>
</html> 