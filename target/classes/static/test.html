<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功能测试 - 社交平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .comment-item {
            margin-top: 5px;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- 顶部导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">社交平台</a>
                <div class="d-flex">
                    <button class="btn btn-outline-danger" id="logoutBtn">退出登录</button>
                </div>
            </div>
        </nav>

        <!-- 发布帖子部分 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>发布新帖子</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <textarea class="form-control" id="postContent" rows="3" placeholder="写下你的想法..."></textarea>
                </div>
                <button class="btn btn-primary" id="createPostBtn">发布</button>
            </div>
        </div>

        <!-- 帖子列表 -->
        <div class="card">
            <div class="card-header">
                <h5>帖子列表</h5>
            </div>
            <div class="card-body">
                <div id="postsList"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 检查登录状态：如果未登录则跳转到登录页面
        function checkLogin() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }

        // 退出登录：清除token并跳转到登录页面
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        // AJAX全局设置：为所有请求添加Authorization头，并统一处理错误
        $.ajaxSetup({
            beforeSend: function(xhr) {
                const token = localStorage.getItem('token');
                if (token) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = '请求失败，请检查网络或服务器日志。';
                if (xhr.responseJSON && xhr.responseJSON.msg) {
                    errorMessage = xhr.responseJSON.msg;
                } else if (xhr.responseText) {
                    errorMessage = xhr.responseText.substring(0, 100);
                }
                alert('错误: ' + errorMessage);

                if (xhr.status === 401) {
                    alert('登录状态已失效，请重新登录。');
                    logout();
                }
            }
        });

        // --- 事件绑定 --- //
        $(document).ready(function() {
            if (checkLogin()) {
                loadPosts();
            }

            // 静态按钮的事件绑定
            $('#logoutBtn').on('click', logout);
            $('#createPostBtn').on('click', createPost);

            // 动态生成元素的事件委托
            $('#postsList').on('click', '.like-btn', function() {
                const postId = $(this).data('post-id');
                likePost(postId);
            });

            $('#postsList').on('click', '.delete-post-btn', function() {
                const postId = $(this).data('post-id');
                deletePost(postId);
            });

            $('#postsList').on('click', '.comment-btn', function() {
                const postId = $(this).data('post-id');
                createComment(postId);
            });

            $('#postsList').on('click', '.delete-comment-btn', function() {
                const postId = $(this).data('post-id');
                const commentId = $(this).data('comment-id');
                deleteComment(postId, commentId);
            });
        });

        // --- API 调用函数 --- //

        // 发布帖子
        function createPost() {
            const content = $('#postContent').val();
            if (!content) {
                alert('请输入帖子内容！');
                return;
            }

            $.ajax({
                url: '/api/posts',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ content }),
                success: function(response) {
                    if (response.code === 200) {
                        $('#postContent').val('');
                        loadPosts();
                    } else {
                        alert('发布帖子失败：' + response.msg);
                    }
                }
            });
        }

        // 加载帖子列表
        function loadPosts() {
            $.ajax({
                url: '/api/posts',
                method: 'GET',
                success: function(response) {
                    if (response.code === 200) {
                        displayPosts(response.data);
                    }
                }
            });
        }

        // 显示帖子列表HTML
        function displayPosts(posts) {
            const postsList = $('#postsList');
            postsList.empty();

            if (posts.length === 0) {
                postsList.append('<p class="text-muted">暂无帖子，快来发布第一条吧！</p>');
                return;
            }

            posts.forEach(post => {
                const postHtml = `
                    <div class="card mb-3" data-post-id="${post.id}">
                        <div class="card-body">
                            <h5 class="card-title">${post.content}</h5>
                            <div class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-sm btn-outline-primary like-btn" data-post-id="${post.id}">
                                    点赞 (${post.likesCount || 0})
                                </button>
                                <button class="btn btn-sm btn-danger delete-post-btn" data-post-id="${post.id}">删除</button>
                            </div>
                            
                            <!-- 评论输入区 -->
                            <div class="mt-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="commentInput-${post.id}" placeholder="写下你的评论...">
                                    <button class="btn btn-outline-primary comment-btn" data-post-id="${post.id}">评论</button>
                                </div>
                            </div>

                            <!-- 评论列表区 -->
                            <div id="commentsList-${post.id}" class="mt-3"></div>
                        </div>
                    </div>
                `;
                postsList.append(postHtml);
                loadComments(post.id); // 为每个帖子加载评论
            });
        }

        // 加载评论列表
        function loadComments(postId) {
            $.ajax({
                url: `/api/posts/${postId}/comments`,
                method: 'GET',
                success: function(response) {
                    if (response.code === 200) {
                        displayComments(postId, response.data);
                    }
                }
            });
        }

        // 显示评论列表HTML
        function displayComments(postId, comments) {
            const commentsContainer = $(`#commentsList-${postId}`);
            commentsContainer.empty();

            if (comments.length === 0) {
                commentsContainer.append('<small class="text-muted">暂无评论</small>');
                return;
            }

            comments.forEach(comment => {
                const commentHtml = `
                    <div class="comment-item" data-comment-id="${comment.id}">
                        <p class="mb-1">${comment.content}</p>
                        <small class="text-muted">用户ID: ${comment.userId}</small>
                        <button class="btn btn-sm btn-danger float-end delete-comment-btn" data-post-id="${comment.postId}" data-comment-id="${comment.id}">删除</button>
                    </div>
                `;
                commentsContainer.append(commentHtml);
            });
        }

        // 创建评论
        function createComment(postId) {
            const content = $(`#commentInput-${postId}`).val();
            if (!content) {
                alert('请输入评论内容！');
                return;
            }

            $.ajax({
                url: `/api/posts/${postId}/comments`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ postId: postId, content: content }), 
                success: function(response) {
                    if (response.code === 200) {
                        $(`#commentInput-${postId}`).val(''); // 清空输入框
                        loadComments(postId); // 重新加载评论
                        loadPosts(); // 刷新帖子列表以更新评论数量
                    } else {
                        alert('创建评论失败：' + response.msg);
                    }
                }
            });
        }

        // 删除评论
        function deleteComment(postId, commentId) {
            if (!confirm('确定要删除这条评论吗？')) return;

            $.ajax({
                url: `/api/posts/${postId}/comments/${commentId}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.code === 200) {
                        loadComments(postId); // 重新加载评论
                        loadPosts(); // 刷新帖子列表以更新评论数量
                    } else {
                        alert('删除评论失败：' + response.msg);
                    }
                }
            });
        }

        // 点赞帖子
        function likePost(postId) {
            $.ajax({
                url: `/api/posts/${postId}/like`,
                method: 'POST',
                success: function(response) {
                    if (response.code === 200) {
                        loadPosts(); // 重新加载帖子列表以更新点赞数
                    } else {
                        alert('点赞失败：' + response.msg);
                    }
                }
            });
        }

        // 删除帖子
        function deletePost(postId) {
            if (!confirm('确定要删除这条帖子吗？')) return;

            $.ajax({
                url: `/api/posts/${postId}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.code === 200) {
                        loadPosts(); // 重新加载帖子列表
                    } else {
                        alert('删除帖子失败：' + response.msg);
                    }
                }
            });
        }
    </script>
</body>
</html> 